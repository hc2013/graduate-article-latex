\chapter{系统需求分析与概要设计}



\section{GTDS系统概述}
地理轨迹数据服务总体上分为三个部分，轨迹数据服务，瓦片数据服务和业务展示服务。其中业务展示服务是用户直接操作的前端，完成轨迹数据和瓦片数据的可视化功能。\textbf{注意：由于业务展示服务只有前端库的调用，没有有价值的实现，因此本文不做介绍。}瓦片数据服务主要面向外部数据源，支持瓦片数据源的配置和瓦片的增，删，改，查等功能。轨迹数据服务主要面向数据库管理员，主要功能是负责轨迹存储和相似性检索。


\section{轨迹数据服务需求分析}
\subsection{轨迹数据服务的功能需求}
整个地理轨迹数据服务的核心功能有三个。第一个是对批量轨迹数据导入建立索引的功能。第二个是轨迹检索KNN功能，即根据目标轨迹的ID，执行检索算法，找出与目标轨迹最相近的K 条轨迹。第三个功能是对已有索引新加入数据点，即插入功能。\textbf{注意，在本文所实现的轨迹数据服务中，只提供了增，查，初始化等功能，并没有提供删除功能。之所以放弃删除功能，是因为在大数据量的应用场景下，用户往往只需要动态地增加和查询轨迹数据，轨迹数据总体量一般都达到百万级，每次做KNN 检索的K值也能达到几百，用户并不在意索引中存在某一些冗余的轨迹，相关的删除操作优先级很低。所以本文放弃了删除功能的实现。}

\begin{table}[htb]\footnotesize
\centering
\caption{轨迹数据服务功能需求列表}
\begin{tabular}{|c|c|c|} % 通过添加 | 来表示是否需要绘制竖线
\hline % 在表格最上方绘制横线
\textbf{需求ID}&\textbf{需求名称}&\textbf{需求描述}\\
\hline %在第一行和第二行之间绘制横线
R1&轨迹索引批量初始化&\tabincell{c}{服务调用方能够通过上传批量的轨迹数据，\\ 在规定时间内完成轨迹索引的建立，并返回结果}\\
\hline
R2&相似轨迹knn检索&\tabincell{c}{服务调用方能够通过传递目标轨迹ID和检索量K，\\ 在规定时间内返回K个与目标轨迹最相似的K个轨迹}\\
\hline % 在表格最下方绘制横线
R3&新轨迹数据的插入&\tabincell{c}{服务调用方能够通过传递新轨迹ID和轨迹数据\\ 完成索引更新并返回更新结果}\\
\hline % 在表格最下方绘制横线
\end{tabular}
\label{table:trajectory_service_func_req}
\end{table}

\subsection{轨迹数据服务的非功能需求}
Trajectory KNN问题是一个计算密集型问题，用户对响应时间一定会有要求。同时，并发量也是必须考虑的问题
\begin{table}[htb]\footnotesize
\centering
\caption{轨迹数据服务非功能需求列表}
\begin{tabular}{|c|c|}
\hline
\textbf{时间特性}&\textbf{对于百万级别的轨迹数据量，服务应该在2s之内返回检索结果}\\
\hline %在第一行和第二行之间绘制横线
\textbf{负载特性}&\textbf{服务应该能应对10w以上的并发访问}\\
\hline % 在表格最下方绘制横线
\end{tabular}
\label{table:trajectory_service_non_func_req}
\end{table}

\subsection{轨迹数据服务用例图}
\begin{figure}[H]
  \centering
  \includegraphics[width=5in]{new_FIGs/chapter3/trajectory_system_use_case.pdf}
  \caption{轨迹数据服务用例图}\label{trajectory_system_use_caseCH3}
\end{figure}
\subsection{初始建立轨迹索引用例描述表}
初始建立轨迹索引的使用场景中。最容易出现的问题是，对轨迹数据的元信息配置和对优先点树的元信息配置。由于轨迹数据量很大，不可能让用户手动选定或者上传文件来导入，否则会产生大量人工操作和文件传输的时间消耗。因此，必须采用元信息配置的方式进行。如表格
\ref{table:initVpTree_use_case_description}所示，要充分考虑到用户设置的元信息本身错误或者严重影响索引性能的情况，对于这些情况，系统必须予以更正或警告。
\begin{table}[H]\footnotesize
\centering
\caption{初始建立轨迹索引用例描述表}
\begin{tabular}{|l|l|}
\hline
\textbf{ID}&\textbf{UC1}\\
\hline
\textbf{名称}&\textbf{初始建立轨迹索引}\\
\hline
\textbf{参与者}&\textbf{普通用户}\\
\hline
\textbf{目的}&\textbf{将用户指定的轨迹数据，建立成优先点树索引结构，并返回操作结果}\\
\hline
\textbf{描述}&\textbf{用户通过浏览器选定要建立索引的轨迹数据集合，筛选条件，和数据条目区间，由服务完成索引建立}\\
\hline
\textbf{优先级}&\textbf{高}\\
\hline
\textbf{触发条件}&\textbf{用户需要建立轨迹索引以备相似检索}\\
\hline
\textbf{前置条件}&\textbf{服务正常运行，用户进入操作界面}\\
\hline
\textbf{后置条件}&\textbf{优先点树索引正确建立，持久化到磁盘中，并返回结果给用户}\\
\hline
\textbf{正常流程}&\tabincell{l}{1.进入轨迹数据服务界面 \\ 2.输入轨迹数据表格的ID,筛选条件，目标区间。 \\ 3. 设置优先点树的元数据，包括扇出度，节点数据量等信息。 \\ 4. 点击确认建立索引。}\\
\hline
\textbf{异常流程}&\tabincell{l}{2a.表格ID不存在，服务端发现错误并告知用户 \\2b.筛选条件存在逻辑错误，比如以字符串值筛选整形列。服务器发现错误，要求用户重新输入。 \\2c.目标区间的前后界大小颠倒，前端发现错误，告知用户重新输入。\\ 3a. 用户设置的元数据太大或太小，将会严重影响性能，服务器询问用户是否使用推荐的元信息配置。\\4.a 由于网络，磁盘等各种可能原因导致的初始化失败。服务器应明确告知用户。 }\\
\hline
\end{tabular}
\label{table:initVpTree_use_case_description}
\end{table}

\subsection{插入新数据用例描述表}
在用户的真实使用场景中，有少量的单个导入和批量导入两种可能。针对这两种情形，轨迹数据服务应该分别支持直接导入数据和先导入数据，再配置数据元信息这两种方式。详见表格\ref{table:insert_trajectory_use_case_description}。
\begin{table}[H]\footnotesize
\centering
\caption{插入新数据用例描述表}
\begin{tabular}{|l|l|}
\hline
\textbf{ID}&\textbf{UC2}\\
\hline
\textbf{名称}&\textbf{插入新数据用例描述}\\
\hline
\textbf{参与者}&\textbf{普通用户}\\
\hline
\textbf{目的}&\textbf{新的，单个数据的到来，用户试图将新数据加入到原有索引中}\\
\hline
\textbf{描述}&\textbf{用户通过浏览器提供要插入的新数据，由服务完成将新数据插入到原有索引中的操作}\\
\hline
\textbf{优先级}&\textbf{高}\\
\hline
\textbf{触发条件}&\textbf{用户需要向原有索引中插入新的轨迹数据，以备检索}\\
\hline
\textbf{前置条件}&\textbf{服务正常运行，用户进入操作界面}\\
\hline
\textbf{后置条件}&\textbf{新数据正确插入到原索引中，并持久化在磁盘中，返回结果给用户。}\\
\hline
\textbf{正常流程}&\tabincell{l}{1.进入轨迹数据服务界面 \\ 2.用户提供新的轨迹数据，并选定要插入的目标轨迹数据集合 \\ 3. 点击确认，完成插入}\\
\hline
\textbf{异常流程}&\tabincell{l}{2a.用户要插入的数据量不大，用户可以通过直接上传数据文件的方式进行。 \\2b.用户要插入的数据量较大，则可以通过先导入到数据库中，再通过配置数据库表格元信息的方式 \\ 来指定要插入的数据。 \\2c. 目标轨迹数据集合不存在，服务器告知用户，重新选定。\\3a.由于网络，磁盘等各种可能原因导致的插入失败。服务器应明确告知用户，插入失败。}\\
\hline
\end{tabular}
\label{table:insert_trajectory_use_case_description}
\end{table}
\subsection{相似轨迹检索用例描述表}
相对于初始建立索引和插入新的数据，轨迹相似检索功能不涉及到索引状态的改变。用户操作较为简单，变数较少。详见表格
\ref{table:search_trajectory_use_case_description}
\begin{table}[H]\footnotesize
\centering
\caption{相似轨迹检索用例描述表}
\begin{tabular}{|l|l|}
\hline
\textbf{ID}&\textbf{UC3}\\
\hline
\textbf{名称}&\textbf{相似轨迹检索用例描述}\\
\hline
\textbf{参与者}&\textbf{普通用户}\\
\hline
\textbf{目的}&\textbf{用户想找出轨迹集合中与某一特定轨迹最相近的若干其他轨迹}\\
\hline
\textbf{描述}&\textbf{用户通过浏览器选定要做相似性检索的轨迹，服务进行检索，并返回检索结果}\\
\hline
\textbf{优先级}&\textbf{高}\\
\hline
\textbf{触发条件}&\textbf{用户要做轨迹相似检索}\\
\hline
\textbf{前置条件}&\textbf{服务正常运行，用户进入操作界面}\\
\hline
\textbf{后置条件}&\textbf{服务正确地根据索引进行检索，并将与目标轨迹最相似的若干条轨迹被返回给用户}\\
\hline
\textbf{正常流程}&\tabincell{l}{1.进入轨迹数据服务界面 \\ 2.用户提供目标轨迹数据，设置检索匹配数目K，并选定要搜索的目标轨迹数据集合 \\ 3. 点击确认，进行检索
\\ 4.返回检索结果 }\\
\hline
\textbf{异常流程}&\tabincell{l}{2a.用户要检索的轨迹可以是目标集合中已有的轨迹，此时用户只需要提供目标轨迹的ID即可。 \\2b.用户检索的轨迹不在目标轨迹集合中，此时用户应该首先插入数据到目标集合中或者 \\ 上传轨迹数据文件，是否插入数据应该由用户决定。 \\3a. 目标轨迹数据集合不存在，服务器告知用户，重新选定。\\3b.用户设定的K值过大，检索结果集中数量不足，服务器应该明确告知用户。  \\4a. 由于网络，磁盘等各种可能原因导致的插入失败。服务器应明确告知用户，插入失败。}\\
\hline
\end{tabular}
\label{table:search_trajectory_use_case_description}
\end{table}

\section{瓦片数据服务需求分析}
\subsection{瓦片数据服务的需求综述}
在轨迹检索服务中，对于地图瓦片数据的要求有增加，删除，修改，查询，数据源配置。其中以查询和更新这两部分功能的细分功能最多。对于查询而言，可能被用户需要的有整张地图的全量查询，局部bounding-box渲染查询，单个瓦片数据的查询。对于更新而言，可能需要局部地图的更新，bounding-box更新。
\textbf{注意：在GTDS的功能需求中，对于瓦片的增加和删除都是以整张地图为单位的，局部的增加和删除这种需求并不存在，所以此处不列为功能需求。}
而对于非功能需求，瓦片数据服务涉及到的计算主要是坐标转换，请求解析，缓存处理。计算量不大，所以并不是计算密集型应用，而是IO密集型应用，高并发和快速响应是其必须满足的非功能特性。除此之外，由于瓦片服务本身不存储瓦片数据，用户的瓦片数据可能是存在各种不同的数据库中的，因此服务还应该独立于不同的数据库，做到高可用性，高扩展性。
\subsection{瓦片数据服务功能需求}
\begin{table}[H]\footnotesize
\centering
\caption{瓦片数据服务功能需求列表}
\begin{tabular}{|c|c|l|} % 通过添加 | 来表示是否需要绘制竖线
\hline % 在表格最上方绘制横线
\textbf{需求ID}&\textbf{需求名称}&\textbf{需求描述}\\
\hline
R1&新增地图瓦片数据&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图名称和 \\ 图瓦片数据，增加一个地区的完整地图瓦片数据}\\
\hline
R2&删除地图瓦片数据&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图ID，删 \\ 除一个地区的全部地图瓦片数据}\\
\hline
R3&局部更新地图瓦片数据&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图ID和 \\ 地图数据，更新一张大地图中某一个地区的地图瓦片数据}\\
\hline
R4&bounding-box更新地图瓦片数据&\tabincell{c}{服务调用方能够通过瓦片服务，参数为 \\ 地图ID，经纬度范围，地图数据，更新一张大地图中 \\ 某一个地区某一经纬度矩形范围内的地图瓦片数据}\\
\hline
R5&局部更新地图瓦片数据&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图ID和地 \\ 图数据，更新一张大地图中某一个地区的地图瓦片数据}\\
\hline
R6&地图瓦片数据全量查询&\tabincell{c}{服务调用方能够通过瓦片服务，通过获取全量数据 \\ 的JSON文件，作为输入的数据源，获取整张地图的全量数据}\\
\hline
R7&单个地图瓦片数据查询&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图ID和栅 \\ 格坐标zxy，获取指定的瓦片}\\
\hline
R8&局部bounding-box的渲染查询&\tabincell{c}{服务调用方能够通过瓦片服务，参数为地图ID和 \\ 经纬度矩形范围，获取这一部分的地图渲染结果}\\
\hline
\end{tabular}
\label{table:tile_service_func_req}
\end{table}

\subsection{瓦片数据服务非功能需求}
\begin{table}[H]\footnotesize
\centering
\caption{瓦片数据服务非功能需求列表}
\begin{tabular}{|c|c|}
\hline
\textbf{时间特性}&\textbf{在正常负载情况下，服务的平均响应时间应在1s之内}\\
\hline %在第一行和第二行之间绘制横线
\textbf{负载特性}&\textbf{服务能稳定应对百万级别的并发访问，不会出现延迟超过10s或服务崩溃的情况}\\
\hline % 在表格最下方绘制横线
\textbf{高可用性}&\textbf{服务能通过设置中间件的方式，便捷地对接到各种不同的数据库，并保证运行正常}\\
\hline % 在表格最下方绘制横线
\end{tabular}
\label{table:trajectory_service_non_func_req}
\end{table}

\subsection{瓦片数据服务用例图}
\begin{figure}[H]
  \centering
  \includegraphics[width=5in]{new_FIGs/chapter3/tileserver_use_case.pdf}
  \caption{瓦片数据服务用例图}\label{tileserver_use_caseCH3}
\end{figure}
\textbf{注意：以上用例中的功能并不是逻辑完备的，某些逻辑功能，比如局部地图瓦片非渲染查询，这种需求在实际应用中没有使用场景，这里就没有列举。}
\subsection{瓦片数据服务用例描述}
瓦片数据服务的部分功能操作简单明确，无需使用用例描述。本文只对操作比较复杂的“b-box更新地图瓦片数据”和“特定区域瓦片数据中心渲染”进行了具体描述。
\subsection{b-box更新地图瓦片数据用例描述表}
\begin{table}[htb]\footnotesize
\centering
\caption{bounding-box更新地图瓦片数据用例描述表}
\begin{tabular}{|l|l|}
\hline
\textbf{ID}&\textbf{UC1}\\
\hline
\textbf{名称}&\textbf{bounding-box更新地图瓦片数据}\\
\hline
\textbf{参与者}&\textbf{普通用户}\\
\hline
\textbf{目的}&\textbf{更新某张地图中一个矩形范围内的瓦片数据，以改变轨迹展示背景}\\
\hline
\textbf{描述}&\textbf{用户通过浏览器发送矩形参数和瓦片数据，以实现对瓦片数据库中数据的修改，进而改变业务展示的结果}\\
\hline
\textbf{优先级}&\textbf{高}\\
\hline
\textbf{触发条件}&\textbf{某一地图中某一部分数据发生变更，需要更改}\\
\hline
\textbf{前置条件}&\textbf{服务正常运行，用户进入服务界面}\\
\hline
\textbf{后置条件}&\textbf{地图瓦片数据完成更新，业务展示结果经过刷新可以看到地图变化}\\
\hline
\textbf{正常流程}&\tabincell{l}{1.进入瓦片数据更新界面 \\ 2.设置north,south,west,east,4个经纬度值 \\ 3.设置zoom区间 \\ 4.设置是否进行精度模糊 \\ 5.点击浏览本地文件并上传文件数据 \\6. 点击更新瓦片数据}\\
\hline
\textbf{异常流程}&\tabincell{l}{2a.经纬度大小值错误，前端应自动检测并警告 \\ 3a.指定矩形范围太小，在较小的zoom下无法更新瓦片,服务端应发现错误并返回告知用户 \\ 5a.用户选择的文件格式错误，则前端对用户发出警告 \\ 5b.用户选择的文件中并没有指定bounding-box中的数据，服务端应返回错误报告并挺行用户更改文件}\\
\hline
\end{tabular}
\label{table:tileserver_use_case_description1}
\end{table}

\subsection{特定区域瓦片数据中心渲染用例描述表}
\begin{table}[htb]\footnotesize
\centering
\caption{特定区域瓦片数据中心渲染用例描述表}
\begin{tabular}{|l|l|}
\hline
\textbf{ID}&\textbf{UC2}\\
\hline
\textbf{名称}&\textbf{特定区域瓦片数据中心渲染}\\
\hline
\textbf{参与者}&\textbf{普通用户}\\
\hline
\textbf{目的}&\textbf{获取某一区域内的瓦片数据的渲染效果}\\
\hline
\textbf{描述}&\textbf{用户通过浏览器发送选定的经纬度范围和想要渲染的风格，获取到对应区域的该风格渲染效果}\\
\hline
\textbf{优先级}&\textbf{高}\\
\hline
\textbf{触发条件}&\textbf{用户只想看某一区域的地图}\\
\hline
\textbf{前置条件}&\textbf{服务正常运行，用户进入服务界面}\\
\hline
\textbf{后置条件}&\textbf{渲染效果返回给用户，展示在浏览器上}\\
\hline
\textbf{正常流程}&\tabincell{l}{1.进入局部渲染界面 \\2.选定目标地图 \\3.设置中心点经纬度坐标和区域的长度和宽度，特定的风格以及特定的zoom\\ 4. 点击获取渲染效果图}\\
\hline
\textbf{异常流程}&\tabincell{l}{2a.目标地图不存在，服务器端返回错误报告。 \\3a.经纬度大小值错误，前端应自动检测并警告 \\3b.用户选择的zoom 过大，超过了目标地图的最大分辨率，服务器端返回错误报告。}\\
\hline
\end{tabular}
\label{table:tileserver_use_case_description2}
\end{table}

\section{GTDS系统概要设计}
\begin{figure}[H]
  \centering
  \includegraphics[width=5in]{new_FIGs/chapter3/general_structure.pdf}
  \caption{GTDS的总体架构}\label{general_structureCH3}
\end{figure}
如图~\ref{general_structureCH3}所示，可视化服务将用户界面的操作行为和轨迹数据，发送给轨迹数据服务，又从轨迹数据服务获得轨迹索引的更新结果和检索结果。对于瓦片存储服务，可视化服务负责地理数据范围等参数和瓦片数据发送，并接受从瓦片存储服务回传的检索结果瓦片数据和数据状态。
可视化服务依赖再使用前端库汇总这两部分的数据共同完成可视化功能。\textbf{值得注意的是，瓦片存储服务本身不存储瓦片数据，只负责地图范围的解析、地理坐标的转换以及数据格式的转换，瓦片数据的存放位置是在具体的瓦片数据库中。}
\section{本章总结}
本章先是通过概述说明了整个系统主要组件的职责和相互之间的关系。然后分别针对两个主要服务进行了需求分析。需求分析的过程中，使用了需求列表来展现主要的功能需求和非功能需求，还使用了用例图的形式对功能较多的地图瓦片服务进行了功能划分，并对其中操作较为复杂的功能使用用例描述进行了详细介绍。最后给出了整个系统的概要设计，明确了各个组件之间的依赖关系，为下一章按照模块进行详细设计和实现做准备。
