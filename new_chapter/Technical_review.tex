\chapter{相关技术概念综述}

\section{优先点树}
\subsection{NN问题}
Nearest Neighbour 问题，即最近邻居问题。指的是针对空间中的一个点集，定义一个距离函数d（这里的距离函数d包括但不仅限于欧几里得距离），那么对于一个给定的目标搜索点q，找到距离q 点的距离最小一个点\citenjup{DBLP:journals/ijon/Mateos-GarciaGS19}，这就是最近邻居问题。相对应的，要找到与q点距离最近的K个点，就是KNN问题。

针对NN问题，如果采用线性遍历的方式考虑所有点，将会造成很大的性能损耗。而一个比较合理的思路是，将二分查找的逻辑应用于点集合的检索，从而能将时间损耗降低为log(N)级别。也就是说，如果能够实现以nlog(N)的时间消耗将点集合建立成某种有序的数据结构。那么在搜索时，就可以通过类似于二分查找的方式达到log(N)级别的速度。
\citenjup{DBLP:conf/soda/Yianilos93}

\subsection{优先点树概述}
vp-tree(vantage point tree),中文名称，优先点树，正是上述思路的一种实现。vp-tree从原理上说，是基于三角不等式进行递归分解的剪枝技术，其核心思想奠基了两种情况下剪枝行为的正确性。第一种，是在检索过程中，对于那些远远超出搜索范围的分支，就不需要进行搜索了。第二种，是当搜索目标点显然在某一个范围内的时候，外部的其他分支就都不必搜索了。\citenjup{DBLP:journals/tc/FukunagaN75}基于这两个原则，搜索点的数量和点之间距离计算的次数都被大幅度地减少，从而显著提升了搜索性能。

\subsection{优先点树基本原理与节点结构}
vp-tree的基本思路就是对点集合进行空间划分。第一步，要选择一个点作为vantage point，也就是优先点，作为空间划分中心点。第二步，集合中的其他所有点要计算自己与优先点之间的距离。第三步，根据距离值的大小升序排序，然后将点集合均分为两支，距离小于等于中值的点组成left/inside子集合，距离大于中值的点组成right/outside子集合。
\citenjup{DBLP:conf/eccv/2008-2}第四步，以left/inside集合作为左子树的根节点，right/outside集合为右子树的根节点，再针对这两棵子树分别递归地进行上述划分，从而形成一颗平衡的二叉树，如图\ref{vp_left_rightCH2}中①所示。而根据上述的点集合划分过程，可以得出一棵最简单的两路优先点树的结构应该如图\ref{vp_left_rightCH2}中②所示，其每个非叶子节点都包括一个用于标识优先点的VP-ID，一个中值mu和分别指向左右子树的两个指针。
\begin{figure}[htb]
  \centering
  \includegraphics[width=4in]{new_FIGs/chapter2/vp_left_right1.pdf}
  \caption{vp-tree点集合分割示意图}\label{vp_left_rightCH2}
\end{figure}
通过以上这样的平衡二叉树树结构，优先点树实际上实现了对整个空间中的点集合进行了连续的球状二分。在整个数据空间中，大量的数据点集合被以不同的优先点为中心划分成了大量的相互交错的球型子空间，如图\ref{ball_type_split}所示，\textbf{图片来自\citenjup{DBLP:conf/soda/Yianilos93}}。优先点树的搜索行为正是基于这样的球状的子空间切分，通过判断目标数据点与优先点之间的距离关系来实现搜索路径的剪枝，从而提升搜索性能的。关于优先点树的搜索过程，详见下文。
\begin{figure}
\centering
\begin{minipage}[c]{0.5\textwidth}
\centering
\includegraphics[width=2.4in,height=2.2in]{new_FIGs/chapter2/vp_tree_decomposition.pdf}
\caption{球状空间分割}\label{ball_type_split}
\end{minipage}%
\begin{minipage}[c]{0.5\textwidth}
\centering
\includegraphics[width=2.9in,height=2.2in]{new_FIGs/chapter2/vp-search-line.pdf}
\caption{优先点距离分布折线图}\label{vp_distance_line}
\end{minipage}
\end{figure}
\subsection{两路优先点树的搜索过程}
优先点树的搜索算法的运行思路如算法\ref{alg:simplest_vp_tree_search}所示。对于一次检索的目标点target和当前优先点树的节点node，我们会设置一个容忍距离u。首先计算target 与当前节点的优先点之间的距离distance。如果距离$ distance \ge mu+u $,那么基于三角不等式，左子树中不可能存在距离target点距离小于容忍距离u的点，从而舍弃左子树，只搜索右子树。反之，如果$ distance \le mu-u $, 就舍弃右子树，只搜索左子树。如果$ mu-u < distance < mu+u $, 那么无法完成剪枝，左右子树都要搜索。

如优先点距离分布折线图\ref{vp_distance_line}所示，假设任意点集合的距离分布都符合正态分布。图中正中虚线为中值mu的位置,左右两条虚线分别代表mu-u和mu+u的位置，那么显而易见的是，容忍阈值u 越小，区间(mu-u,mu+u)越短，目标点落入这一区间的可能性越小，剪枝成功的可能性越大，搜索性能也就越好。因此容忍距离u的选择至关重要，在实际的算法实现中，一般的做法都是随着递归搜索的过程推进而不断以当前距离target 最小的距离取代容忍距离u，因为既然u 是目前最小的距离，那么比u距离更大的点也就不必考虑了。因此，如何实现算法使得容忍阈值以较快的速度收敛，是算法实现的重点。
\begin{algorithm}[H]
\caption{最简单vp-tree的搜索过程search}
\label{alg:simplest_vp_tree_search}
node $\leftarrow$ currentNode;\\
\If {node==null}{
return
}
distance $\leftarrow$ distance(target,node.vp);\\
\If {distance \textless \ u} {
u $\leftarrow$ distance;\\
best $\leftarrow$ node.vp;
}
\If {distance  $\geq$ \ mu-u}{
search(node.right);
}
\If{ distance  $\leq$ \ mu+u}{
search(node.left);
}
\end{algorithm}

\section{豪斯多夫距离}
“豪斯多夫距离是在度量空间中任意两个集合之间定义的一种距离。设X和Y是度量空间M的两个真子集，那么豪斯多夫距离$d_{H}(X,Y)$是最小的数r使得X的闭r―邻域包含Y，Y的闭r―邻域也包含X，其通用计算公式如下。”\citenjup{DBLP:journals/cys/VargasB18}
\begin{align}
d_{H}(X,Y)=\max \left\{ \sup _{x \in X} \inf _{y \in Y}d(x,y),\sup _{y \in Y} \inf _{x \in X}d(x,y) \right\}\label{hausdoff-formula1}
\end{align}
这里要介绍导向距离的概念，所谓导向距离，就是一个集合中的某个点到另一个集合中所有点的所有距离的最小值中的最大值。这意味着两个集合之间的导向距离在很多情况下都不是对称的,即$H(X,Y) \ne H(Y,X)$。如图\ref{oriented-distance-show}中①所示，集合A到集合B的导向距离是d(a1,b1)，而集合B到集合A的导向距离d(b2,a2)。
\begin{figure}[htb]
  \centering
  \includegraphics[width=3.5in,height=2in]{new_FIGs/chapter2/hausdoff-show.pdf}
  \caption{导向距离示例}\label{oriented-distance-show}
\end{figure}
对于豪斯多夫距离，更通俗的定义是两个集合最小\textbf{导向距离}的最大值。因此对于豪斯多夫距离，更通用的公式表达如下。
\begin{align}
H_{}(X,Y)=\max \left\{h_{}(X,Y),h_{}(Y,X)\right\}\label{hausdoff-formula2}
\end{align}
在公式\ref{hausdoff-formula2}中，$h(X,Y)$是集合X到集合Y的导向距离，也称为前向距离。反之，$h(Y,X)$为后向距离。对于几何图形和线条而言，前后向距离的计算应该包括线条上的所有点，而不只是线条的顶点，如图\ref{oriented-distance-show}中②所示。但是对于线条上所有点的距离计算显然是不现实的，只能采用某种折中的近似方法，尽可能地保留几何体的空间距离属性，在后文的详细设计中，本文将会介绍具体的折中实现办法。

\section{Lucene}
\subsection{简介}
Lucene是一套用于全文检索的开放源代码Java程序库，由Apache软件基金会支持和提供。所谓全文检索，指的是针对无结构的，纯字符串内容的检索，而不只是针对类似于日期，地点这样的结构化内容。Lucene 提供了一个简洁强大的应用程序接口，能够做全文索引和搜索。“在Java开发环境里Lucene是一个成熟的免费开放源代码工具；就其本身而论，Lucene 是现在并且是这几年，最受欢迎的免费Java 信息检索程序库。”\citenjup{DBLP:journals/aai/HirschB18}

这里要明确的是，“Lucene并不是一个完整有形的搜索引擎，而只是一个Java类库，对于不同的索引和搜索内容它是通用的，从而赋予了应用程序极大的灵活性和实现空间，而且Lucene 的设计紧凑而简单，能够很容易地嵌入到各种应用环境中。”\citenjup{DBLP:journals/jdiq/YangFL18}
\subsection{运行原理}
Lucene是基于索引进行检索的。其核心流程如图~\ref{lucene_structureCH2}所示，用户通过Search User Interface来与Lucene库进行交互，Lucene是基于索引Index进行检索的，其创建索引的过程是针对文档内容进行抽取，分词，索引的过程，而检索行为封装为Lucene Query,不同语义的Query作用于Lucene Index，再经由Render Result返回检索结果给用户。
\citenjup{LuceneInAction}注意：图中Index 的含义是Lucene各种检索数据结构的概称，并不单指倒排或正排索引。在本文的设计与实现中，轨迹相似检索功能就是封装成LuceneQuery来供用户使用的。
\begin{figure}[htb]
  \centering
  \includegraphics[width=3.5in,height=3in]{new_FIGs/chapter2/lucene-structure.pdf}
  \caption{lucene检索组件图}\label{lucene_structureCH2}
\end{figure}
\subsection{Lucene核心数据结构}
Doc-Value:Doc-Value是Lucene针对文档内容建立的正排索引，可以将其理解为以Doc-Id为key的键值对的正序组合结构。这一结构与传统数据库中B-tree的索引结构是相似的。主要用于对一些特殊的结构化数据，比如图形，大数字，日志等不适合进行全文检索的数据进行顺序存储。本文实现中所使用的几何图形JTSGeometry 就是存储在Doc-Value中的。

\subsection{为什么选择lucene}
lucene本身是一个全文检索的代码库，其代码简洁，优雅，扩展性良好，而且运行稳定。扩展Lucene的索引结构，再应用于Lucene的Query语义是非常可控的设计行为。而且Lucene与本文所使用的几何体类库JTS.Geomtry是兼容的，这就使得可以直接使用JTS的几何类库，降低了编码的难度。

\section{地理相关技术概念介绍}
\subsection{地理坐标与投影法}
WGS-84坐标系（World Geodetic System一1984 Coordinate System），是一种通用的世界地心坐标系。该坐标系颁布于1984年，它充分利用了当时所有的技术和工艺，全面考虑了地球重力场，地理几何和地理测量等多方面的因素，制定了一个某一时刻的，按照某一恒定速率旋转的标准地球坐标体系。WGS-84坐标系的坐标原点为地球质心，Z轴方向与BIH （国际时间服务机构）1984.O 定义的协议地球极（CTP) 方向相同，X 轴是协议地球子午面与WGS基准子午面的交线，Y轴与Z轴，X轴构成右手正交坐标系。WGS84坐标系也被称为1984 年世界大地坐标系统，是目前最新的地球模型。\citenjup{WGS84Intro}在本文的地图坐标应用场景下，所有的初始经纬度坐标都是WGS-84坐标值。

地图投影法，是遵循一定的数学规则，把不规则的地球表面的复杂地理信息映射到平面地图的理论方法。地图投影出于表达和理解上的正确性，必须遵循三个主要的不变原则，即角度不变，面积不变，距离不变。

墨卡托投影法（英语：Mercator projection），又称麦卡托投影法，是一种保证角度不变的圆柱形地图投影方式，因此也被称为等角正切圆柱投影。它以本初子午线与赤道交点为投影坐标原点，将赤道投影为X轴，将本初子午线投影为Y轴，从而构成墨卡托平面直角坐标系。此投影法之所以被称为墨卡托投影，是因为其作者为法兰德斯地理学家杰拉杜斯・墨卡托。1569年，他以此投影法为坐标基础绘制了一幅长202 公分、宽124 公分的世界地图。由于角度不变形的保证，该地图经纬线于任何位置皆垂直相交。从而大大降低了地图信息的复杂性。

如公式\ref{raw_mercator}所示为墨卡托投影法的计算公式，其中a为地球椭球的长轴，b为短轴，θ为经度弧度值，取值区间为(-π,+π),正值为东经，负值为西经。φ 为纬度值弧度值，取值区间为(-π/2,+π/2)，北纬取正值，南纬取负值，e为地球椭球体第一偏心率。\citenjup{MercatoProjection}
\begin{equation}\label{raw_mercator}
\left\{
\begin{split}
&x=a \times \theta  \\
&y=a \times \lbrack \ln \tan(\frac{\pi}{4}+\frac{\phi}{2})+\frac{e}{2}\ln(\frac{1-e \times \sin \phi}{1+e \times \sin \phi}) \rbrack\\
\end{split}
\right.
\end{equation}

原生墨卡托投影法由于考虑到地球的椭球体事实，使得公式比较复杂，不利于计算机网络传输和计算，由此产生了简化的需求。Web墨卡托投影法就是为了方便地图数据在网络上计算传输渲染的，对原生墨卡托投影的一种简化变形的坐标投影法。它与原生墨卡托投影的一个重要区别是，Web 墨卡托投影忽略了地球作为一个椭球体的客观事实，出于计算简单，直接将地球视作一个标准球体，这就造成了Web 墨卡托投影法与原生墨卡托投影法存在0.33\% 的精度差别。但是它的计算公式较之于原生墨卡托投影简化了很多，极大地方便了地图信息在网络间的传输和在浏览器上的渲染。在本文的详细设计章节的局部地图更新功能设计中，就是对公式\ref{web_mercator}的等价变换实现，完成了WGS-84坐标到Web 墨卡托坐标的变换，从而将经纬度转换为瓦片坐标，作为局部更新的位置依据。

\begin{equation}\label{web_mercator}
\left\{ 
\begin{split}
&x=a \times \theta  \\
&y=a \times \ln \tan(\frac{\pi}{4}+\frac{\phi}{2})\\
\end{split}
\right.
\end{equation}
\subsection{地图瓦片}
地图瓦片指的是通过经过墨卡托投影为平面的世界地图，在不同的地图分辨率(整个世界地图的像素大小)下，通过切割的方式将世界地图划分为像素为$256\times256$的地图单元，划分成的每一块地图单元称为地图瓦片。\citenjup{TileIntro}每一个瓦片在地图平面内对应的横轴、纵轴坐标就是瓦片坐标。
如图\ref{tilePyramid2CH2}所示。瓦片等级level和瓦片坐标（tileX,tileY)一同唯一确定了一个二进制数据就是瓦片数据。瓦片数据包括栅格瓦片数据和矢量瓦片数据。\citenjup{DBLP:conf/w2gis/AntoniouMH09}在通用的数据存储格式中，一般都是把level,x,y 作为一张数据库表格的唯一主键，瓦片数据作为列值进行存储。

\subsection{瓦片金字塔}
瓦片金字塔模型是一种多分辨率层次模型，从瓦片金字塔的底层到顶层，分辨率越来越低，但表示的地理范围不变。首先确定地图服务平台所要提供的缩放级别的数量N，把缩放级别最高、地图比例尺最大的地图图片作为金字塔的底层，即第0层，并对其进行分块。从地图图片的左上角开始，从左至右、从上到下进行切割，分割成相同大小(比如256x256像素)的正方形地图瓦片。形成第0层瓦片矩阵;在第0层地图图片的基础上，按每2x2像素合成为一个像素的方法生成第1 层地图图片，并对其进行分块，分割成与下一层相同大小的正方形地图瓦片，形成第1层瓦片矩阵;采用同样的方法生成第2层瓦片矩阵;…;如此下去，直到第N 层，进而构成整个瓦片金字塔。\citenjup{TilePyramid}
\section{Nodejs Express框架}
Express 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，协助开发者创建各种 Web 和移动设备应用。本文应用Express框架作为地理瓦片数据服务的基础框架，以对外提供Rest访问接口。
\section{本章小结}
本章主要介绍开发本系统所涉及到相关技术概念，首先介绍了优先点树的概念，原理和结构，然后介绍了全文检索库Lucene的组件和检索原理，最后介绍了地理相关的技术概念，包括地图坐标，投影法，地图瓦片和瓦片金字塔等概念。
